name: üß™ Run Tests

on: [push, pull_request]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      # --- 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç ---
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # --- 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python ---
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ---
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      # --- 4Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Chrome –¥–ª—è Selenium ---
      - name: üåê Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver

      # --- 5Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã + –ø–æ–∫—Ä—ã—Ç–∏–µ ---
      - name: üöÄ Run tests with coverage
        env:
          # üîπ SMTP-—Å–µ–∫—Ä–µ—Ç—ã (—Å–æ–∑–¥–∞—é—Ç—Å—è —Ç–≤–æ–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º)
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          # üîπ Chrome –¥–ª—è UI-—Ç–µ—Å—Ç–æ–≤
          CHROME_BIN: /usr/bin/chromium-browser
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ pytest —Å –æ—Ç—á—ë—Ç–æ–º –æ –ø–æ–∫—Ä—ã—Ç–∏–∏"
          PYTHONPATH=. pytest -v --cov=app --cov-report=json --cov-report=term-missing --cov-fail-under=85

      # --- 6Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç, –µ—Å–ª–∏ Selenium –ø–∞–¥–∞–ª ---
      - name: üì∏ Upload Selenium screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-screenshot
          path: screenshot.png
          if-no-files-found: ignore

      # --- 7Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á—ë—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ ---
      - name: üìä Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          if-no-files-found: ignore
